<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="chopin">
<title>Distribute computational workloads over multiple threads • chopin</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Distribute computational workloads over multiple threads">
<meta property="og:description" content="chopin">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">chopin</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.01242024</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/v00_good_practice_parallelization.html">Good practice of scomps with HPC</a>
    <a class="dropdown-item" href="../articles/v01_generate_computational_grid.html">Generate computational grids</a>
    <a class="dropdown-item" href="../articles/v02_distribute_process_ext.html">Distribute computational workloads over multiple threads</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Distribute computational workloads over multiple threads</h1>
            
            <h4 data-toc-skip class="date">2023-12-18</h4>
      
      
      <div class="d-none name"><code>v02_distribute_process_ext.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="plan">Plan<a class="anchor" aria-label="anchor" href="#plan"></a>
</h2>
<ul>
<li>Be planned before you distribute your workload to multiple threads.
Major points include:
<ul>
<li>The peak memory consumption of your process with a small dataset:
you can employ the power of parallel processing as far as your
computational assets allow. The total memory size may be the highest
hurdle for this. Users are strongly recommended to run a small (e.g.,
target points in a computational grid) example then estimate the total
memory demand. Roughly speaking, your machine should be equipped with
the memory exceeding (number of threads to be drawn) * (the peak memory
usage per thread).</li>
<li>Small datasets are good with the single-thread processing: this
package leverages <code>terra</code> and <code>exactextractr</code> in
major processing helper functions. They are based on C++ backends, where
users can get a decent performance with just one thread and a relatively
small amount of memory capacity. Factors to choose to stay single-thread
or go on with multi-thread processing are:
<ul>
<li>The spatial and temporal resolutions of raster datasets</li>
<li>The spatial extent and study period</li>
<li>The number of points to be processed</li>
<li>Other factors affect the intermediate products’ complexity: when you
use a set of polygons to summarize raster values, the intermediate
memory consumption will depend on the number of vertices in polygon
datasets. We recommend users simplify complex polygon features before
processing if the simplification does not or trivially impact the
expected results.</li>
<li>These factors interact; for instance, even if the raster has a fine
resolution and the large spatial extent, you will not find any
performance gain with multi-thread processing when you have a small
number of points to process.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span>, warning <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<ul>
<li><p>A motivating example is extracting mean elevation at 10
kilometers circular point buffers using digital elevation model (DEM)
data from Shuttle Radar Topography Mission satellite. We prepared the
dataset from <code>elevatr</code> package. You may consult the package
tutorial for retrieving data directly from OpenTopography via
<code>elevatr</code>.</p></li>
<li><p>We start with a polygon dataset in North Carolina. This dataset
is included in <code>sf</code> package.</p></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">scomps</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://doFuture.futureverse.org" class="external-link">doFuture</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris" class="external-link">tigris</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>sf_use_s2 <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2023</span>, kind <span class="op">=</span> <span class="st">"L'Ecuyer-CMRG"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="use-case-1-mean-elevation-at-circular-points-buffers">Use case 1: mean elevation at circular points buffers<a class="anchor" aria-label="anchor" href="#use-case-1-mean-elevation-at-circular-points-buffers"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shape/nc.shp"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">ncsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">ncpoly</span><span class="op">)</span></span>
<span><span class="va">ncsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">ncsf</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">ncsf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-3-1.png" alt=""><p class="caption">plot of chunk unnamed-chunk-3</p>
</div>
<ul>
<li>To demonstrate, a set of 1,000 random points are generated inside
the polygons:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoints</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">ncsf</span>, <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/point-generation-1.png" alt=""><p class="caption">plot of chunk point-generation</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># st_sample output is st_sfc. We should convert it to sf</span></span>
<span><span class="va">ncpoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span></span>
<span><span class="va">ncpoints</span><span class="op">$</span><span class="va">pid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ul>
<li>SpatRaster objects in <code>terra</code> package should be
serialized to compress then reuse elsewhere. For serialization and
de-serialization, <code><a href="https://rdrr.io/pkg/terra/man/wrap.html" class="external-link">terra::wrap</a></code> and
<code><a href="https://rdrr.io/pkg/terra/man/wrap.html" class="external-link">terra::unwrap</a></code> need to be used.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srtm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/wrap.html" class="external-link">unwrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../../tests/testdata/nc_srtm15_otm.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">srtm</span></span></code></pre></div>
<pre><code><span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 1534, 2281, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 391.5026, 391.5026  (x, y)</span></span>
<span><span class="co">## extent      : 1012872, 1905890, 1219961, 1820526  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : +proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## name        : file928c3830468b </span></span>
<span><span class="co">## min value   :        -3589.291 </span></span>
<span><span class="co">## max value   :         1946.400</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">srtm</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/load-srtm-1.png" alt=""><p class="caption">plot of chunk load-srtm</p>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">srtm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"EPSG:5070"</span></span></code></pre></div>
<ul>
<li>Modern computers usually have more than two threads, which enables
users to perform many tasks at the same time. Provided that users have
machines with sufficient memory, which runs much faster than network or
storage, one can reduce the total processing time by employing multiple
threads for processing data.</li>
<li>Users need to consider several things before leveraging multi-thread
processing in geospatial computation:
<ul>
<li>The computation task should be divisible: the simplest statement
would be the computation at each split must not be related to
another.</li>
<li>Each dataset for processing needs to be split beforehand.</li>
<li>Know the characteristics of function you want to parallelize:
<ul>
<li>Does the function call entire data into memory or refer to the
location then read values on demand?</li>
<li>Does the function work with parallel processing?</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="section level4">
<h4 id="single-thread-processing">Single-thread processing<a class="anchor" aria-label="anchor" href="#single-thread-processing"></a>
</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoints_tr</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">ncpoints</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>    <span class="va">ncpoints_srtm</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu">scomps</span><span class="fu">::</span><span class="fu">extract_with</span><span class="op">(</span></span>
<span>            vector <span class="op">=</span> <span class="va">ncpoints_tr</span>,</span>
<span>            raster <span class="op">=</span> <span class="va">srtm</span>,</span>
<span>            id <span class="op">=</span> <span class="st">"pid"</span>,</span>
<span>            mode <span class="op">=</span> <span class="st">"buffer"</span>,</span>
<span>            radius <span class="op">=</span> <span class="fl">1e4L</span><span class="op">)</span> <span class="co"># 10,000 meters (10 km)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   6.067   0.199   6.266</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="multi-thread-processing">Multi-thread processing<a class="anchor" aria-label="anchor" href="#multi-thread-processing"></a>
</h4>
<ul>
<li>Given that the data are distributed across North Carolina, we will
consider splitting the points into subregions by grids.</li>
<li>
<code>scomps</code> package has
<code>get_computational_regions</code> to help splitting the entire
study region.
<ul>
<li>Please note that <code>get_computational_regions</code> will accept
<code>padding</code> argument, by which users can get <em>padded</em>
grids to avoid missing raster cells from original unit grid
boundaries.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compregions</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">scomps</span><span class="fu">::</span><span class="fu">get_computational_regions</span><span class="op">(</span></span>
<span>        <span class="va">ncpoints_tr</span>,</span>
<span>        mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>        nx <span class="op">=</span> <span class="fl">8L</span>,</span>
<span>        ny <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>        padding <span class="op">=</span> <span class="fl">1e4L</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">compregions</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "original" "padded"</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oldpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfcol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">compregions</span><span class="op">$</span><span class="va">original</span>, main <span class="op">=</span> <span class="st">"Original grids"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">compregions</span><span class="op">$</span><span class="va">padded</span>, main <span class="op">=</span> <span class="st">"Padded grids"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/generate-compregion-1.png" alt=""><p class="caption">plot of chunk generate-compregion</p>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>In the figure above, the padded grids have overlaps one another.
<code>get_computational_regions</code> automatically expand a little
more than the input argument <code>padding</code>.</p>
<p>Now, we will distribute the computational process for these
grids.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multicore</span>, workers <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="fu">doFuture</span><span class="fu">::</span><span class="fu"><a href="https://doFuture.futureverse.org/reference/registerDoFuture.html" class="external-link">registerDoFuture</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>    <span class="va">ncpoints_srtm_mthr</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu">scomps</span><span class="fu">::</span><span class="fu">distribute_process_grid</span><span class="op">(</span></span>
<span>            grids <span class="op">=</span> <span class="va">compregions</span>,</span>
<span>            grid_target_id <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>            fun_dist <span class="op">=</span> <span class="fu">scomps</span><span class="fu">::</span><span class="va">extract_with</span>,</span>
<span>            vector <span class="op">=</span> <span class="va">ncpoints_tr</span>,</span>
<span>            raster <span class="op">=</span> <span class="va">srtm</span>,</span>
<span>            id <span class="op">=</span> <span class="st">"pid"</span>,</span>
<span>            mode <span class="op">=</span> <span class="st">"buffer"</span>,</span>
<span>            radius <span class="op">=</span> <span class="fl">1e4L</span></span>
<span>        <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 1</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 2</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 3</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 4</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 5</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 6</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 7</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 8</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 9</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 10</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 11</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 12</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 13</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 14</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 15</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 16</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 17</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 18</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 19</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 20</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 21</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 22</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 23</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 24</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 25</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 26</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 27</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 28</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 29</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 30</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 31</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 32</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 33</span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   6.558   1.304   3.540</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoints_srtm_mthr</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">ncpoints_srtm_mthr</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">ncpoints_srtm_mthr</span><span class="op">$</span><span class="va">pid</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">ncpoints_srtm</span>, <span class="va">ncpoints_srtm_mthr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Attributes: &lt; Component \"row.names\": Mean relative difference: 0.6567904 &gt;"</span></span>
<span><span class="co">## [2] "Component \"mean\": Mean relative difference: 8.712634e-05"</span></span></code></pre>
<p>Let’s find what the results look like.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpoints_s</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/terra/man/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">ncpoints</span>, <span class="va">ncpoints_srtm</span><span class="op">)</span></span>
<span><span class="va">ncpoints_m</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/terra/man/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">ncpoints</span>, <span class="va">ncpoints_srtm_mthr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ncpoints_s</span><span class="op">[</span>, <span class="st">"mean"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Single-thread"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/vis-results-1.png" alt=""><p class="caption">plot of chunk vis-results</p>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ncpoints_m</span><span class="op">[</span>, <span class="st">"mean"</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Multi-thread"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figure/vis-results-2.png" alt=""><p class="caption">plot of chunk vis-results</p>
</div>
</div>
<div class="section level3">
<h3 id="distribute-computation-through-geographic-hierarchy">Distribute computation through geographic hierarchy<a class="anchor" aria-label="anchor" href="#distribute-computation-through-geographic-hierarchy"></a>
</h3>
<ul>
<li>We consider “hierarchy,” which is usually embedded in many
geospatial datasets. Suppose we want to summarize elevation across
census geographies in North Carolina. The census geographies are highly
organized in order; think of state, counties, zip code areas, census
tracts, block groups, and blocks. Some of these are exhaustive to the
higher order geographies (e.g., census block groups are exhaustively
delineated in a census tract), whereas some do not (not all zip code
areas are exhaustively covered by a county).</li>
<li>In this example, we consider census tracts and counties to
distribute the computation task for mean elevation values at census
tracts over counties.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"../testdata/nc_hierarchy.gpkg"</span><span class="op">)</span></span>
<span><span class="va">nc_county</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">nc_county</span>, layer <span class="op">=</span> <span class="st">"county"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `county' from data source </span></span>
<span><span class="co">##   `/Users/songi2/Documents/GitHub/Scalable_GIS/tools/testdata/nc_hierarchy.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 100 features and 1 field</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 1054155 ymin: 1341756 xmax: 1838923 ymax: 1690176</span></span>
<span><span class="co">## Projected CRS: NAD83 / Conus Albers</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc_tracts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"../testdata/nc_hierarchy.gpkg"</span><span class="op">)</span></span>
<span><span class="va">nc_tracts</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">nc_tracts</span>, layer <span class="op">=</span> <span class="st">"tracts"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `tracts' from data source </span></span>
<span><span class="co">##   `/Users/songi2/Documents/GitHub/Scalable_GIS/tools/testdata/nc_hierarchy.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 2672 features and 1 field</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 1054155 ymin: 1341756 xmax: 1838923 ymax: 1690176</span></span>
<span><span class="co">## Projected CRS: NAD83 / Conus Albers</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc_county</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">nc_county</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="va">nc_tracts</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">nc_tracts</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="va">nc_tracts</span><span class="op">$</span><span class="va">COUNTY</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">nc_tracts</span><span class="op">$</span><span class="va">GEOID</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="single-thread-processing-1">Single-thread processing<a class="anchor" aria-label="anchor" href="#single-thread-processing-1"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>    <span class="va">nc_elev_tr_single</span> <span class="op">&lt;-</span> <span class="fu">scomps</span><span class="fu">::</span><span class="fu">extract_with</span><span class="op">(</span></span>
<span>        vector <span class="op">=</span> <span class="va">nc_tracts</span>,</span>
<span>        raster <span class="op">=</span> <span class="va">srtm</span>,</span>
<span>        id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>        mode <span class="op">=</span> <span class="st">"polygon"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.992   0.033   1.026</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="multi-thread-processing-through-hierarchy">Multi-thread processing through hierarchy<a class="anchor" aria-label="anchor" href="#multi-thread-processing-through-hierarchy"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>    <span class="va">nc_elev_tr_distr</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu">scomps</span><span class="fu">::</span><span class="fu">distribute_process_hierarchy</span><span class="op">(</span></span>
<span>            regions <span class="op">=</span> <span class="va">nc_county</span>, <span class="co"># higher level geometry</span></span>
<span>            split_level <span class="op">=</span> <span class="st">"GEOID"</span>, <span class="co"># higher level unique id</span></span>
<span>            fun_dist <span class="op">=</span> <span class="fu">scomps</span><span class="fu">::</span><span class="va">extract_with</span>,</span>
<span>            vector <span class="op">=</span> <span class="va">nc_tracts</span>, <span class="co"># lower level geometry</span></span>
<span>            raster <span class="op">=</span> <span class="va">srtm</span>,</span>
<span>            id <span class="op">=</span> <span class="st">"GEOID"</span>, <span class="co"># lower level unique id</span></span>
<span>            func <span class="op">=</span> <span class="st">"mean"</span></span>
<span>        <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.021   0.015   1.285</span></span></code></pre>
<p>It is clearly shown that several thousands of features may not get
benefits from parallel processing. However, this approach will be
helpful when each geographic area is large and the raster data is too
large to handle.</p>
</div>
<div class="section level3">
<h3 id="multi-thread-processing-over-large-rasters">Multi-thread processing over large rasters<a class="anchor" aria-label="anchor" href="#multi-thread-processing-over-large-rasters"></a>
</h3>
<p>In many cases users have parallelized over multiple files, i.e.,
large raster files. Leveraging memory-saving <code>terra</code>’s C++
pointers, users will want to use
<code>distribute_process_multirasters</code>, where they are assumed to
have the raster file paths to distribute. In standard vector-raster
overlays, <code>distribute_process_multirasters</code> will help
especially when users have multiple sizable raster files to extract
values with moderately sized vectors.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncpath</span> <span class="op">&lt;-</span> <span class="st">"../testdata/nc_hierarchy.gpkg"</span></span>
<span><span class="va">nccnty</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">ncpath</span>, layer <span class="op">=</span> <span class="st">"county"</span><span class="op">)</span></span>
<span><span class="va">ncelev</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/wrap.html" class="external-link">unwrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../testdata/nc_srtm15_otm.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">ncelev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"EPSG:5070"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ncelev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"srtm15"</span><span class="op">)</span></span>
<span><span class="va">tdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">ncelev</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="st">"test1.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">ncelev</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="st">"test2.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">ncelev</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="st">"test3.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">ncelev</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="st">"test4.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">ncelev</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tdir</span>, <span class="st">"test5.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">testfiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"*.tif$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">testfiles</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "/var/folders/58/7rn_bn5d6k3_cxwnzdhswpz4n0z2n9/T//Rtmp1SCbAI/test1.tif"</span></span>
<span><span class="co">## [2] "/var/folders/58/7rn_bn5d6k3_cxwnzdhswpz4n0z2n9/T//Rtmp1SCbAI/test2.tif"</span></span>
<span><span class="co">## [3] "/var/folders/58/7rn_bn5d6k3_cxwnzdhswpz4n0z2n9/T//Rtmp1SCbAI/test3.tif"</span></span>
<span><span class="co">## [4] "/var/folders/58/7rn_bn5d6k3_cxwnzdhswpz4n0z2n9/T//Rtmp1SCbAI/test4.tif"</span></span>
<span><span class="co">## [5] "/var/folders/58/7rn_bn5d6k3_cxwnzdhswpz4n0z2n9/T//Rtmp1SCbAI/test5.tif"</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/distribute_process_multirasters.html">distribute_process_multirasters</a></span><span class="op">(</span></span>
<span>      filenames <span class="op">=</span> <span class="va">testfiles</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_with_polygons</span>,</span>
<span>      polys <span class="op">=</span> <span class="va">nccnty</span>,</span>
<span>      surf <span class="op">=</span> <span class="va">ncelev</span>,</span>
<span>      id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      func <span class="op">=</span> <span class="st">"mean"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">GEOID</th>
<th align="right">mean</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">37037</td>
<td align="right">136.80203</td>
</tr>
<tr class="even">
<td align="left">37001</td>
<td align="right">189.76170</td>
</tr>
<tr class="odd">
<td align="left">37057</td>
<td align="right">231.16968</td>
</tr>
<tr class="even">
<td align="left">37069</td>
<td align="right">98.03845</td>
</tr>
<tr class="odd">
<td align="left">37155</td>
<td align="right">41.23463</td>
</tr>
<tr class="even">
<td align="left">37109</td>
<td align="right">270.96933</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="distributing-sfterra-functions">Distributing sf/terra functions<a class="anchor" aria-label="anchor" href="#distributing-sfterra-functions"></a>
</h3>
<p>Users also can pass generic terra functions to multiple threads.</p>
<p>Some considerations apply: - If a function to calculate the nearest
distance, edge cases may present especially when the target dataset are
too sparse to be located in the padded calculation extent. For example,
when users want to distribute <code><a href="https://rdrr.io/pkg/terra/man/nearby.html" class="external-link">terra::nearest()</a></code> to calculate
the nearest distance from ranch locations to the primary roads, some
ranch locations might have no destination primary roads if the
calculation grids are too finely defined. - We strongly assume that
users have unique identifiers in input data. The passed argument in
<code>distribute_process_*</code> functions is expected to include
<code>id</code> argument to designate the origin locations’ unique
identifiers.</p>
<div class="section level4">
<h4 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h4>
<ul>
<li>The example below shows how to distribute a <code>terra</code>
function <code>nearest</code> is distributed over regular computational
grids.</li>
</ul>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pnts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../testdata/nc_random_point.rds"</span><span class="op">)</span></span>
<span><span class="va">pnts</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">pnts</span><span class="op">)</span></span>
<span><span class="va">rd1</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"../testdata/ncroads_first.gpkg"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pnts</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">pnts</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="va">rd1</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">rd1</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">nccompreg</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/get_computational_regions.html">get_computational_regions</a></span><span class="op">(</span></span>
<span>                              input <span class="op">=</span> <span class="va">pnts</span>,</span>
<span>                              mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>                              nx <span class="op">=</span> <span class="fl">6L</span>,</span>
<span>                              ny <span class="op">=</span> <span class="fl">4L</span>,</span>
<span>                              padding <span class="op">=</span> <span class="fl">3e4L</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">multicore</a></span>, workers <span class="op">=</span> <span class="fl">6L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/distribute_process_grid.html">distribute_process_grid</a></span><span class="op">(</span></span>
<span>                          grids <span class="op">=</span> <span class="va">nccompreg</span>,</span>
<span>                          fun_dist <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/terra/man/nearby.html" class="external-link">nearest</a></span>,</span>
<span>                          x <span class="op">=</span> <span class="va">pnts</span>,</span>
<span>                          y <span class="op">=</span> <span class="va">rd1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 1</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 2</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 3</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 4</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 5</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 6</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 7</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 8</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 9</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 10</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 11</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 12</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 13</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 14</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 15</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 16</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 17</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 18</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 19</span></span>
<span><span class="co">## Your input function was </span></span>
<span><span class="co">##             successfully run at CGRIDID: 20</span></span></code></pre>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.311   0.266   0.197</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">restr</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/nearby.html" class="external-link">nearest</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pnts</span>, y <span class="op">=</span> <span class="va">rd1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.034   0.001   0.036</span></span></code></pre>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Insang Song, Kyle Messier.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
